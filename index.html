<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì´ë¯¸ì§€ PDF ë³€í™˜ + OCR ì„ íƒ + ë‹¤êµ­ì–´ ì§€ì›</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f2f5f9;
        color: #333;
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      p {
        font-size: 1rem;
        margin-bottom: 1rem;
        max-width: 600px;
        text-align: center;
      }
      input[type="file"] {
        margin: 1rem 0;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: white;
        width: 100%;
        max-width: 600px;
      }
      #fileList {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1rem 0;
        width: 100%;
        max-width: 600px;
        min-height: 50px;
      }
      .file-item {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }
      .file-controls button {
        margin-left: 0.5rem;
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
      }
      button.convert-btn {
        background: #0070f3;
        color: white;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
        margin-top: 1rem;
        max-width: 600px;
        width: 100%;
      }
      button.convert-btn:hover {
        background: #005ac1;
      }
      #output {
        margin-top: 2rem;
        max-width: 800px;
        width: 100%;
        text-align: left;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 300px;
        overflow-y: auto;
        font-family: Consolas, monospace;
        font-size: 0.9rem;
      }
      #progressContainer {
        width: 100%;
        max-width: 600px;
        margin: 1rem 0;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        height: 20px;
        display: none;
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background: #0070f3;
        transition: width 0.3s ease;
      }
      #options {
        max-width: 600px;
        width: 100%;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 1rem;
        box-sizing: border-box;
      }
      #options label {
        display: inline-flex;
        align-items: center;
        margin-right: 1rem;
        cursor: pointer;
        user-select: none;
      }
      #options input[type="checkbox"] {
        margin-right: 0.3rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ì´ë¯¸ì§€ë¥¼ PDFë¡œ ë³€í™˜ + OCR (ì„ íƒ ê°€ëŠ¥)</h1>
    <p>
      JPG, PNG, HEIC, WEBP, BMP, TIFF ë“± ë‹¤ì–‘í•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê°€ëŠ¥. OCRì€
      ì„ íƒì ìœ¼ë¡œ ì‹¤í–‰í•˜ë©°, ì›í•˜ëŠ” ì–¸ì–´ë¥¼ ë‹¤ì¤‘ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <input
      type="file"
      id="fileInput"
      accept="image/*,.heic,.tiff,.bmp"
      multiple
    />

    <div id="fileList"></div>

    <div id="options">
      <label><input type="checkbox" id="doOCR" checked /> OCR ìˆ˜í–‰í•˜ê¸°</label>
      <div>
        <strong>OCR ì–¸ì–´ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥):</strong><br />
        <label
          ><input type="checkbox" class="lang" value="kor" checked /> í•œêµ­ì–´
          (kor)</label
        >
        <label
          ><input type="checkbox" class="lang" value="eng" checked /> ì˜ì–´
          (eng)</label
        >
        <label
          ><input type="checkbox" class="lang" value="jpn" /> ì¼ë³¸ì–´
          (jpn)</label
        >
        <label
          ><input type="checkbox" class="lang" value="rus" /> ëŸ¬ì‹œì•„ì–´
          (rus)</label
        >
        <label
          ><input type="checkbox" class="lang" value="chi_sim" /> ì¤‘êµ­ì–´ ê°„ì²´
          (chi_sim)</label
        >
        <label
          ><input type="checkbox" class="lang" value="spa" /> ìŠ¤í˜ì¸ì–´
          (spa)</label
        >
      </div>
    </div>

    <button class="convert-btn" id="startBtn">
      ğŸ“„ PDFë¡œ ë³€í™˜ + OCR (ì„ íƒëœ ì–¸ì–´)
    </button>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <div id="output"></div>

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
      let selectedFiles = [];

      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");
      const doOCRCheckbox = document.getElementById("doOCR");
      const startBtn = document.getElementById("startBtn");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const outputDiv = document.getElementById("output");

      fileInput.addEventListener("change", (e) => {
        selectedFiles = Array.from(e.target.files);
        renderFileList();
      });

      function move(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= selectedFiles.length) return;
        [selectedFiles[index], selectedFiles[newIndex]] = [
          selectedFiles[newIndex],
          selectedFiles[index],
        ];
        renderFileList();
      }

      function renderFileList() {
        fileList.innerHTML = "";
        selectedFiles.forEach((file, idx) => {
          const div = document.createElement("div");
          div.className = "file-item";
          div.innerHTML = `
          <span>${file.name}</span>
          <span class="file-controls">
            <button onclick="move(${idx}, -1)">â¬†</button>
            <button onclick="move(${idx}, 1)">â¬‡</button>
          </span>
        `;
          fileList.appendChild(div);
        });
      }

      async function startConversion() {
        if (!selectedFiles.length) {
          alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        // OCR ìˆ˜í–‰ ì—¬ë¶€
        const doOCR = doOCRCheckbox.checked;

        // ì„ íƒëœ OCR ì–¸ì–´
        const langs = Array.from(
          document.querySelectorAll(".lang:checked")
        ).map((c) => c.value);
        if (doOCR && langs.length === 0) {
          alert("OCR ì–¸ì–´ë¥¼ ìµœì†Œ í•œ ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        startBtn.disabled = true;
        outputDiv.innerHTML = "";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";

        const pdfDoc = await PDFLib.PDFDocument.create();

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          // ì§„í–‰ë„ ì—…ë°ì´íŠ¸ (íŒŒì¼ ì²˜ë¦¬ ë¹„ìœ¨)
          progressBar.style.width = `${Math.floor(
            (i / selectedFiles.length) * 100
          )}%`;

          let imageFile = file;

          if (file.type === "image/heic") {
            try {
              const convBlob = await heic2any({
                blob: file,
                toType: "image/jpeg",
              });
              imageFile = new File(
                [convBlob],
                file.name.replace(/\.heic$/i, ".jpg"),
                { type: "image/jpeg" }
              );
            } catch (e) {
              alert("HEIC ë³€í™˜ ì‹¤íŒ¨: " + e.message);
              startBtn.disabled = false;
              progressContainer.style.display = "none";
              return;
            }
          }

          const imageBytes = await imageFile.arrayBuffer();

          // ì´ë¯¸ì§€ ì‚½ì…
          let img;
          if (imageFile.type.startsWith("image/jpeg")) {
            img = await pdfDoc.embedJpg(imageBytes);
          } else if (imageFile.type.startsWith("image/png")) {
            img = await pdfDoc.embedPng(imageBytes);
          } else {
            // PDF-Libê°€ ì§€ì›í•˜ëŠ” ì´ë¯¸ì§€ ìœ í˜• ì™¸ì—ëŠ” PNGë¡œ ë³€í™˜ í•„ìš” - ì—¬ê¸°ì„  PNGë§Œ ê¸°ë³¸ì§€ì›, HEICëŠ” ìœ„ì—ì„œ JPGë¡œ ë³€í™˜
            alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹: " + imageFile.type);
            startBtn.disabled = false;
            progressContainer.style.display = "none";
            return;
          }

          const page = pdfDoc.addPage([img.width, img.height]);
          page.drawImage(img, {
            x: 0,
            y: 0,
            width: img.width,
            height: img.height,
          });

          // OCR ìˆ˜í–‰ ì‹œ
          if (doOCR) {
            outputDiv.textContent += `\n[${file.name}] OCR ì§„í–‰ ì¤‘...\n`;
            const result = await performOCR(
              imageFile,
              langs,
              i,
              selectedFiles.length
            );
            outputDiv.textContent += result + "\n\n";
            outputDiv.scrollTop = outputDiv.scrollHeight;
          }
        }

        // PDF ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "converted.pdf";
        link.textContent = "PDF ë‹¤ìš´ë¡œë“œ";
        link.style.display = "block";
        link.style.marginTop = "1rem";
        link.style.textAlign = "center";
        link.style.fontWeight = "bold";
        link.style.color = "#0070f3";

        outputDiv.appendChild(link);

        progressBar.style.width = "100%";
        startBtn.disabled = false;
        progressContainer.style.display = "none";
      }

      async function performOCR(file, langs, index, total) {
        return new Promise(async (resolve, reject) => {
          try {
            const langStr = langs.join("+");
            const worker = Tesseract.createWorker({
              logger: (m) => {
                if (m.status === "recognizing text") {
                  const progressPercent = Math.floor(m.progress * 100);
                  progressBar.style.width = `${Math.floor(
                    ((index + m.progress) / total) * 100
                  )}%`;
                  outputDiv.textContent = `íŒŒì¼ ${
                    index + 1
                  }/${total} OCR ì§„í–‰: ${progressPercent}%\n`;
                }
              },
            });
            await worker.load();
            await worker.loadLanguage(langStr);
            await worker.initialize(langStr);

            const {
              data: { text },
            } = await worker.recognize(file);
            await worker.terminate();
            resolve(text.trim());
          } catch (err) {
            reject("OCR ì˜¤ë¥˜: " + err.message);
          }
        });
      }

      startBtn.addEventListener("click", startConversion);

      // move í•¨ìˆ˜ ì „ì—­ ë“±ë¡ (íŒŒì¼ ì´ë™ë²„íŠ¼ìš©)
      window.move = move;
    </script>
  </body>
</html>
