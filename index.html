<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì´ë¯¸ì§€ PDF + OCR ë³€í™˜ê¸° (HEIC ì§€ì› & ë“œë˜ê·¸ ìˆœì„œ ì¡°ì •)</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f2f5f9;
        color: #333;
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      p {
        font-size: 1rem;
        margin-bottom: 1rem;
        max-width: 600px;
        text-align: center;
      }
      #dropZone {
        width: 100%;
        max-width: 600px;
        height: 150px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin: 1rem 0;
        background: #f7f7f7;
        user-select: none;
      }
      #dropZone.dragging {
        background: #e0e0e0;
      }
      input[type="file"] {
        display: none;
      }
      #fileList {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1rem 0;
        width: 100%;
        max-width: 600px;
        list-style: none;
        padding: 0;
      }
      .file-item {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: grab;
      }
      .file-item:active {
        cursor: grabbing;
      }
      .file-name {
        flex-grow: 1;
        user-select: text;
      }
      button.convert-btn {
        background: #0070f3;
        color: white;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
        margin-top: 1rem;
        user-select: none;
      }
      button.convert-btn:hover {
        background: #005ac1;
      }
      #output {
        margin-top: 2rem;
        max-width: 800px;
        text-align: left;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        white-space: pre-wrap;
      }
      .progress-container {
        width: 100%;
        max-width: 600px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        margin: 1rem 0;
        height: 20px;
      }
      .progress-bar {
        height: 100%;
        width: 0;
        background: #0070f3;
        transition: width 0.3s ease;
      }
      .ocr-options {
        margin: 1rem 0;
        max-width: 600px;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .ocr-options label {
        margin-right: 1rem;
        cursor: pointer;
        user-select: none;
      }
      .ocr-languages {
        margin-top: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .ocr-languages label {
        display: flex;
        align-items: center;
      }
      .ocr-languages input[type="checkbox"] {
        margin-right: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ì´ë¯¸ì§€ë¥¼ PDFë¡œ ë³€í™˜í•˜ê³  OCR í…ìŠ¤íŠ¸ ì¸ì‹í•˜ê¸°</h1>
    <p>
      JPG, PNG, HEIC, HEIF, WEBP, BMP, TIFF ë“± ë‹¤ì–‘í•œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê°€ëŠ¥.<br />
      OCR ì–¸ì–´ ì„ íƒ ë° ìˆ˜í–‰ ì—¬ë¶€ ì§€ì • ê°€ëŠ¥í•˜ë©°, ì‚¬ì§„ ìˆœì„œë¥¼ ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬
      ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div id="dropZone">ì—¬ê¸°ì— ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
    <input
      type="file"
      id="fileInput"
      accept="image/*,.heic,.heif,.tiff,.bmp"
      multiple
    />

    <ul id="fileList"></ul>

    <div class="ocr-options">
      <label><input type="checkbox" id="doOCR" checked /> OCR ìˆ˜í–‰í•˜ê¸°</label>
      <div class="ocr-languages">
        <label><input type="checkbox" value="kor" checked /> í•œêµ­ì–´</label>
        <label><input type="checkbox" value="eng" checked /> ì˜ì–´</label>
        <label><input type="checkbox" value="jpn" /> ì¼ë³¸ì–´</label>
        <label><input type="checkbox" value="rus" /> ëŸ¬ì‹œì•„ì–´</label>
        <label><input type="checkbox" value="chi_sim" /> ì¤‘êµ­ì–´ (ê°„ì²´)</label>
        <label><input type="checkbox" value="spa" /> ìŠ¤í˜ì¸ì–´</label>
      </div>
    </div>

    <button class="convert-btn" onclick="startConversion()">
      ğŸ“„ PDFë¡œ ë³€í™˜ + OCR ì¸ì‹
    </button>

    <div class="progress-container" style="display: none">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="output"></div>

    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");
      const outputDiv = document.getElementById("output");
      const progressContainer = document.querySelector(".progress-container");
      const progressBar = document.getElementById("progressBar");
      const doOCRCheckbox = document.getElementById("doOCR");

      let selectedFiles = [];

      // ë“œë˜ê·¸ì•¤ë“œë¡­ ë° í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragging");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragging");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragging");
        const files = Array.from(e.dataTransfer.files);
        addFiles(files);
      });

      fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        addFiles(files);
        fileInput.value = ""; // ì¤‘ë³µ ì„ íƒ ë°©ì§€
      });

      function addFiles(files) {
        // ì¤‘ë³µ íŒŒì¼ëª… ì²´í¬ ë° ì¶”ê°€
        files.forEach((file) => {
          if (
            !selectedFiles.some(
              (f) => f.name === file.name && f.size === file.size
            )
          ) {
            selectedFiles.push(file);
          }
        });
        renderFileList();
        outputDiv.innerHTML = "";
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
      }

      function renderFileList() {
        fileList.innerHTML = "";
        selectedFiles.forEach((file, index) => {
          const li = document.createElement("li");
          li.className = "file-item";
          li.setAttribute("data-index", index);
          li.innerHTML = `<span class="file-name">${file.name}</span>`;
          fileList.appendChild(li);
        });
      }

      // SortableJSë¥¼ ì´ìš©í•´ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ìˆœì„œ ì¡°ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
      new Sortable(fileList, {
        animation: 150,
        onEnd: (evt) => {
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          if (oldIndex === newIndex) return;
          // selectedFiles ë°°ì—´ë„ ìˆœì„œ ë³€ê²½ ë°˜ì˜
          const movedItem = selectedFiles.splice(oldIndex, 1)[0];
          selectedFiles.splice(newIndex, 0, movedItem);
          renderFileList();
        },
      });

      async function startConversion() {
        if (selectedFiles.length === 0) {
          alert("ìµœì†Œ í•œ ê°œ ì´ìƒì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        outputDiv.textContent = "";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";

        const doOCR = doOCRCheckbox.checked;
        const languageCheckboxes = document.querySelectorAll(
          ".ocr-languages input[type=checkbox]:checked"
        );
        const languages =
          Array.from(languageCheckboxes)
            .map((el) => el.value)
            .join("+") || "kor";

        // pdf-libë¡œ PDF ë§Œë“¤ê¸°
        const pdfDoc = await PDFLib.PDFDocument.create();

        let fullText = "";
        for (let i = 0; i < selectedFiles.length; i++) {
          progressBar.style.width = `${Math.round(
            (i / selectedFiles.length) * 100
          )}%`;

          const file = selectedFiles[i];
          let imageDataUrl;

          try {
            imageDataUrl = await convertFileToDataURL(file);
          } catch (err) {
            alert(`ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${file.name}`);
            continue;
          }

          const img = new Image();
          img.src = imageDataUrl;

          await new Promise((resolve) => (img.onload = resolve));

          let pdfImage;
          if (file.type.startsWith("image/png")) {
            pdfImage = await pdfDoc.embedPng(imageDataUrl);
          } else {
            pdfImage = await pdfDoc.embedJpg(imageDataUrl);
          }

          const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
          page.drawImage(pdfImage, {
            x: 0,
            y: 0,
            width: pdfImage.width,
            height: pdfImage.height,
          });

          if (doOCR) {
            try {
              const text = await performOCR(imageDataUrl, languages);
              fullText += `----- [${file.name}] -----\n` + text + "\n\n";
            } catch (e) {
              fullText += `----- [${file.name}] -----\nOCR ì‹¤íŒ¨\n\n`;
            }
          }
        }

        progressBar.style.width = `100%`;

        // PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const pdfBytes = await pdfDoc.save();
        const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });
        const pdfUrl = URL.createObjectURL(pdfBlob);

        const downloadLink = document.createElement("a");
        downloadLink.href = pdfUrl;
        downloadLink.download = "converted.pdf";
        downloadLink.textContent = "PDF ë‹¤ìš´ë¡œë“œ";
        downloadLink.style.display = "inline-block";
        downloadLink.style.marginTop = "1rem";
        downloadLink.style.fontWeight = "bold";
        downloadLink.style.color = "#0070f3";
        downloadLink.style.textDecoration = "underline";

        outputDiv.innerHTML = "";
        outputDiv.appendChild(downloadLink);

        if (doOCR) {
          const ocrTextTitle = document.createElement("h3");
          ocrTextTitle.textContent = "OCR ì¸ì‹ ê²°ê³¼:";
          ocrTextTitle.style.marginTop = "1.5rem";

          const ocrTextArea = document.createElement("pre");
          ocrTextArea.textContent = fullText;

          outputDiv.appendChild(ocrTextTitle);
          outputDiv.appendChild(ocrTextArea);
        }
      }

      async function convertFileToDataURL(file) {
        if (
          file.type === "image/heic" ||
          file.name.toLowerCase().endsWith(".heic") ||
          file.name.toLowerCase().endsWith(".heif")
        ) {
          // HEIC/HEIF ë³€í™˜
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function () {
              const blob = new Blob([reader.result]);
              try {
                const conversionResult = await heic2any({
                  blob,
                  toType: "image/jpeg",
                  quality: 0.9,
                });
                const convertedBlob =
                  conversionResult instanceof Blob
                    ? conversionResult
                    : conversionResult[0];
                const convReader = new FileReader();
                convReader.onload = () => resolve(convReader.result);
                convReader.onerror = () => reject("HEIC ë³€í™˜ ì‹¤íŒ¨");
                convReader.readAsDataURL(convertedBlob);
              } catch (e) {
                reject("HEIC ë³€í™˜ ì¤‘ ì˜¤ë¥˜");
              }
            };
            reader.onerror = () => reject("HEIC íŒŒì¼ ì½ê¸° ì‹¤íŒ¨");
            reader.readAsArrayBuffer(file);
          });
        } else {
          // ì¼ë°˜ ì´ë¯¸ì§€
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject("ì´ë¯¸ì§€ ì½ê¸° ì‹¤íŒ¨");
            reader.readAsDataURL(file);
          });
        }
      }

      async function performOCR(dataUrl, languages) {
        return new Promise((resolve, reject) => {
          Tesseract.recognize(dataUrl, languages, {
            logger: (m) => {
              // ì§„í–‰ ìƒí™© ì½˜ì†” ì¶œë ¥ (ì„ íƒ ì‚¬í•­)
              // console.log(m);
            },
          })
            .then(({ data: { text } }) => {
              resolve(text.trim());
            })
            .catch(reject);
        });
      }
    </script>
  </body>
</html>
