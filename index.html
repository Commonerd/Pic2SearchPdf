<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="JPG, PNG, HEIC 이미지를 PDF로 병합하고 OCR 인식까지! 한국어/영어/일본어/러시아어 지원. 무료, 빠르고 간편한 이미지 PDF 변환기."
    />
    <meta
      name="keywords"
      content="이미지 PDF 변환, OCR, JPG to PDF, HEIC 변환, tesseract.js, 이미지 텍스트 인식, 한국어 OCR, 러시아어 OCR, 이미지 병합"
    />
    <meta name="robots" content="index, follow" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <title>pic2searchpdf - 이미지 PDF + 다국어 OCR 변환기</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f9f9f9;
        padding: 2rem;
        text-align: center;
      }
      h1 {
        font-size: 2rem;
        color: #333;
      }
      input[type="file"] {
        margin: 1rem 0;
      }
      button {
        background: #1a73e8;
        color: white;
        padding: 0.7rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #output {
        margin-top: 2rem;
      }
      canvas {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>이미지를 PDF로 변환하고 텍스트 인식하기 (OCR)</h1>
    <p>JPG, PNG, HEIC, WEBP 등을 업로드하세요. 다국어 OCR 지원.</p>
    <input type="file" id="fileInput" accept="image/*,.heic" multiple />
    <br />
    <button onclick="startConversion()">PDF로 변환 + OCR 인식</button>
    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script>
      async function startConversion() {
        const files = document.getElementById("fileInput").files;
        if (!files.length) {
          alert("파일을 선택하세요.");
          return;
        }

        const pdfDoc = await PDFLib.PDFDocument.create();
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "<p>변환 중... (이미지 처리 및 OCR 분석)</p>";

        for (const file of files) {
          let imageFile = file;

          // HEIC 변환
          if (file.type === "image/heic") {
            try {
              const convBlob = await heic2any({
                blob: file,
                toType: "image/jpeg",
              });
              imageFile = new File(
                [convBlob],
                file.name.replace(/\.heic$/i, ".jpg"),
                { type: "image/jpeg" }
              );
            } catch (e) {
              alert("HEIC 변환 실패: " + file.name);
              continue;
            }
          }

          const reader = new FileReader();
          const imageDataUrl = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(imageFile);
          });

          const img = new Image();
          img.src = imageDataUrl;
          await new Promise((res) => (img.onload = res));

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imgBytes = await fetch(canvas.toDataURL("image/jpeg")).then(
            (res) => res.arrayBuffer()
          );
          const pdfImage = await pdfDoc.embedJpg(imgBytes);
          const page = pdfDoc.addPage([img.width, img.height]);
          page.drawImage(pdfImage, {
            x: 0,
            y: 0,
            width: img.width,
            height: img.height,
          });

          // OCR 실행
          await Tesseract.recognize(img, "kor+eng+jpn+rus", {
            logger: (m) => console.log(m),
          }).then(({ data: { text } }) => {
            const pre = document.createElement("pre");
            pre.textContent = `▶ ${file.name} 인식결과:\n` + text;
            outputDiv.appendChild(pre);
          });
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "output.pdf";
        link.textContent = "⬇ OCR 포함 PDF 다운로드";
        outputDiv.appendChild(link);
      }
    </script>
  </body>
</html>
