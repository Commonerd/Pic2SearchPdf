<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Pic2SearchPdf: ì´ë¯¸ì§€ PDF & OCR ë³€í™˜ê¸° (HEIC ì§€ì›, ë“œë˜ê·¸ ìˆœì„œ ì¡°ì •)
    </title>
    <meta
      name="description"
      content="Pic2SearchPdfëŠ” HEIC, JPG, PNG ë“± ë‹¤ì–‘í•œ ì´ë¯¸ì§€ë¥¼ OCR í…ìŠ¤íŠ¸ ì¸ì‹ ê¸°ëŠ¥ì´ í¬í•¨ëœ ê²€ìƒ‰ ê°€ëŠ¥í•œ PDFë¡œ ë³€í™˜í•´ì£¼ëŠ” ë¬´ë£Œ ì˜¨ë¼ì¸ ë„êµ¬ì…ë‹ˆë‹¤. ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ê°„í¸í•˜ê²Œ íŒŒì¼ ìˆœì„œë¥¼ ì¡°ì •í•˜ê³ , í•œê¸€/ì˜ì–´ ë“± ë‹¤ì–‘í•œ ì–¸ì–´ì˜ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”."
    />
    <meta
      name="keywords"
      content="ì´ë¯¸ì§€ PDF, OCR ë³€í™˜, HEIC PDF, HEIF PDF, JPG PDF, PNG PDF, ì‚¬ì§„ í…ìŠ¤íŠ¸ ì¶”ì¶œ, ë¬´ë£Œ OCR, ì˜¨ë¼ì¸ PDF ë³€í™˜, ë¬¸ì„œ ìŠ¤ìº” PDF, ì•„ì´í° ì‚¬ì§„ PDF, í•œê¸€ OCR, ì˜ì–´ OCR, ê²€ìƒ‰ ê°€ëŠ¥í•œ PDF"
    />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <style>
      /* ê¸°ì¡´ CSS ìœ ì§€ ë° ê°œì„  (ë¯¸ë¦¬ë³´ê¸°, ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë ¨ UI ì¶”ê°€) */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f2f5f9;
        color: #333;
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      h1 {
        font-size: 2.2rem;
        margin-bottom: 0.8rem;
        text-align: center;
        color: #0070f3;
      }
      p {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        max-width: 700px;
        text-align: center;
        line-height: 1.6;
      }
      #dropZone {
        width: 100%;
        max-width: 650px;
        height: 180px;
        border: 3px dashed #a0d0ff; /* ë”ìš± ëˆˆì— ë„ëŠ” ìƒ‰ìƒ */
        border-radius: 12px;
        display: flex;
        flex-direction: column; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì •ë ¬ */
        justify-content: center;
        align-items: center;
        cursor: pointer;
        margin: 1.5rem 0;
        background: #e6f3ff; /* ë°ì€ ë°°ê²½ìƒ‰ */
        user-select: none;
        transition: background 0.3s ease, border-color 0.3s ease;
      }
      #dropZone:hover {
        background: #d9ecff;
        border-color: #0070f3;
      }
      #dropZone.dragging {
        background: #cce0f5;
        border-color: #005ac1;
      }
      .drop-icon {
        font-size: 3rem; /* ì•„ì´ì½˜ í¬ê¸° í‚¤ìš°ê¸° */
        color: #0070f3;
        margin-bottom: 0.5rem;
      }
      input[type="file"] {
        display: none;
      }
      #fileList {
        display: grid; /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½ */
        grid-template-columns: repeat(
          auto-fill,
          minmax(120px, 1fr)
        ); /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í¬ê¸° ì¡°ì • */
        gap: 15px;
        margin: 1.5rem 0;
        width: 100%;
        max-width: 900px; /* ë” ë„“ì€ ì˜ì—­ */
        list-style: none;
        padding: 0;
      }
      .file-item {
        background: white;
        padding: 0.7rem;
        border-radius: 8px;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
        align-items: center;
        cursor: grab;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
      }
      .file-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .file-item:active {
        cursor: grabbing;
      }
      .file-preview {
        width: 100px; /* ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ í¬ê¸° */
        height: 100px;
        object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€ */
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }
      .file-name {
        font-size: 0.85rem;
        text-align: center;
        word-break: break-all;
        height: 2.5em; /* ë‘ ì¤„ê¹Œì§€ í‘œì‹œ */
        overflow: hidden;
      }
      .remove-file-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.8rem;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s ease;
      }
      .remove-file-btn:hover {
        opacity: 1;
      }
      button.convert-btn {
        background: #0070f3;
        color: white;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        margin-top: 1.5rem;
        user-select: none;
        box-shadow: 0 4px 10px rgba(0, 112, 243, 0.3);
      }
      button.convert-btn:hover {
        background: #005ac1;
        transform: translateY(-2px);
      }
      #output {
        margin-top: 2.5rem;
        max-width: 900px;
        width: 100%;
        text-align: left;
        background: #fff;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        white-space: pre-wrap;
      }
      .progress-container {
        width: 100%;
        max-width: 650px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        margin: 1.5rem 0;
        height: 25px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .progress-bar {
        height: 100%;
        width: 0;
        background: linear-gradient(
          to right,
          #0070f3,
          #00c1ff
        ); /* ê·¸ë¼ë°ì´ì…˜ íš¨ê³¼ */
        transition: width 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .ocr-options {
        margin: 1.5rem 0;
        max-width: 650px;
        width: 100%;
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        border: 1px solid #eee;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .ocr-options label {
        margin-right: 1.5rem;
        cursor: pointer;
        user-select: none;
        font-weight: 500;
      }
      .ocr-languages {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .ocr-languages label {
        display: flex;
        align-items: center;
        font-weight: normal;
        font-size: 0.95rem;
      }
      .ocr-languages input[type="checkbox"] {
        margin-right: 6px;
        cursor: pointer;
        transform: scale(1.1);
      }
      .download-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px dashed #eee;
        text-align: center;
      }
      .download-section h3 {
        color: #0070f3;
        margin-bottom: 1rem;
      }
      .download-link {
        background: #28a745; /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìƒ‰ìƒ */
        color: white;
        padding: 0.8rem 1.8rem;
        font-size: 1.1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        text-decoration: none; /* ë§í¬ ë°‘ì¤„ ì œê±° */
        display: inline-block;
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
      }
      .download-link:hover {
        background: #218838;
        transform: translateY(-2px);
      }
      #ocrTextResult {
        background: #f8f8f8;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1.5rem;
        max-height: 400px; /* ìŠ¤í¬ë¡¤ë°” */
        overflow-y: auto;
        font-size: 0.95rem;
        line-height: 1.8;
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }
        h1 {
          font-size: 1.8rem;
        }
        p {
          font-size: 0.95rem;
        }
        #dropZone {
          height: 120px;
        }
        #fileList {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 10px;
        }
        .file-preview {
          width: 80px;
          height: 80px;
        }
        .file-name {
          font-size: 0.8rem;
        }
        .ocr-options label {
          margin-right: 1rem;
          font-size: 0.9rem;
        }
        .ocr-languages label {
          font-size: 0.85rem;
        }
        button.convert-btn {
          padding: 0.8rem 1.5rem;
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <h1>
      ğŸ“¸ Pic2SearchPdf: ì´ë¯¸ì§€ PDF & OCR ë³€í™˜ê¸°
      <span class="emoji">âœ¨</span>
    </h1>
    <p>
      **HEIC, JPG, PNG** ë“± ì–´ë–¤ ì´ë¯¸ì§€ë“  ê²€ìƒ‰ ê°€ëŠ¥í•œ PDFë¡œ ë³€í™˜í•˜ê³ , ì´ë¯¸ì§€ ì†
      í…ìŠ¤íŠ¸ë¥¼ ê°„í¸í•˜ê²Œ ì¶”ì¶œí•˜ì„¸ìš”! íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ììœ ë¡­ê²Œ ì¡°ì •í•˜ê³ ,
      ë³€í™˜ëœ PDFì™€ OCR í…ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <div id="dropZone">
      <span class="drop-icon">â¬†ï¸</span>
      ì—¬ê¸°ì— ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
    </div>
    <input
      type="file"
      id="fileInput"
      accept="image/*,.heic,.heif,.tiff,.bmp"
      multiple
    />

    <ul id="fileList"></ul>

    <div class="ocr-options">
      <label
        ><input type="checkbox" id="doOCR" checked /> ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸(OCR)
        ì¶”ì¶œí•˜ê¸°</label
      >
      <div class="ocr-languages">
        <label><input type="checkbox" value="kor" checked /> í•œêµ­ì–´</label>
        <label><input type="checkbox" value="eng" checked /> ì˜ì–´</label>
        <label><input type="checkbox" value="jpn" /> ì¼ë³¸ì–´</label>
        <label><input type="checkbox" value="chi_sim" /> ì¤‘êµ­ì–´ (ê°„ì²´)</label>
        <label><input type="checkbox" value="spa" /> ìŠ¤í˜ì¸ì–´</label>
        <label><input type="checkbox" value="rus" /> ëŸ¬ì‹œì•„ì–´</label>
        <label><input type="checkbox" value="fra" /> í”„ë‘ìŠ¤ì–´</label>
        <label><input type="checkbox" value="deu" /> ë…ì¼ì–´</label>
      </div>
    </div>

    <button class="convert-btn" onclick="startConversion()">
      ğŸ“„ PDF ë³€í™˜ & í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘í•˜ê¸°
    </button>

    <div class="progress-container" style="display: none">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div id="output" style="display: none">
      <div class="download-section">
        <h3>âœ… ë³€í™˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
        <a
          id="downloadPdfLink"
          class="download-link"
          href="#"
          download="Pic2SearchPdf_converted.pdf"
        >
          ğŸ“¥ PDF íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </a>
      </div>
      <div id="ocrTextResult" style="display: none">
        <h4>ğŸ“„ OCR ì¸ì‹ ê²°ê³¼:</h4>
        <pre id="ocrExtractedText"></pre>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");
      const outputDiv = document.getElementById("output");
      const progressContainer = document.querySelector(".progress-container");
      const progressBar = document.getElementById("progressBar");
      const doOCRCheckbox = document.getElementById("doOCR");
      const downloadPdfLink = document.getElementById("downloadPdfLink");
      const ocrTextResultDiv = document.getElementById("ocrTextResult");
      const ocrExtractedText = document.getElementById("ocrExtractedText");

      let selectedFiles = [];
      let worker; // Tesseract.js worker for better performance

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ íŒŒì¼ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      document.addEventListener("DOMContentLoaded", () => {
        const savedFilesJson = localStorage.getItem("pic2searchpdf_savedFiles");
        if (savedFilesJson) {
          try {
            const savedFiles = JSON.parse(savedFilesJson);
            // File ê°ì²´ ìì²´ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, íŒŒì¼ëª…ë§Œ ë¶ˆëŸ¬ì™€ì„œ UIì— í‘œì‹œ
            // ì‹¤ì œ ë³€í™˜ ì‹œì—ëŠ” ì‚¬ìš©ìê°€ ë‹¤ì‹œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•¨ì„ ì•ˆë‚´í•˜ê±°ë‚˜,
            // ë” ë‚˜ì€ UXë¥¼ ìœ„í•´ IndexedDB ë“±ì„ ê³ ë ¤í•  ìˆ˜ ìˆìœ¼ë‚˜, ì—¬ê¸°ì„œëŠ” ë³´ì•ˆì„ ìœ„í•´ ë‹¨ìˆœí™”
            // í˜„ì¬ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê¸°ëŠ¥ì€ "ì´ì „ ì‘ì—…ì˜ í”ì "ì„ ë³´ì—¬ì£¼ëŠ” ìš©ë„ë¡œ ì‚¬ìš©
            selectedFiles = savedFiles.map((fileInfo) => ({
              name: fileInfo.name,
              type: fileInfo.type,
              size: fileInfo.size,
              lastModified: fileInfo.lastModified,
              dataUrl: fileInfo.dataUrl, // ë¯¸ë¦¬ë³´ê¸° ì¬ìƒì„±ì„ ìœ„í•´ dataUrlë„ ì €ì¥
            }));
            renderFileList();
            if (selectedFiles.length > 0) {
              alert(
                "ì´ì „ ì‘ì—…ì— ì—…ë¡œë“œí–ˆë˜ íŒŒì¼ ëª©ë¡ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ë³€í™˜ì„ ìœ„í•´ ë‹¤ì‹œ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”."
              );
            }
          } catch (e) {
            console.error("Failed to load saved files from local storage:", e);
            localStorage.removeItem("pic2searchpdf_savedFiles");
          }
        }
      });

      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— íŒŒì¼ ì •ë³´ ì €ì¥ (ë³´ì•ˆì„ ìœ„í•´ íŒŒì¼ ë‚´ìš© ëŒ€ì‹  ë©”íƒ€ë°ì´í„°ë§Œ ì €ì¥)
      function saveFilesToLocalStorage() {
        const fileMetadata = selectedFiles.map((file) => ({
          name: file.name,
          type: file.type,
          size: file.size,
          lastModified: file.lastModified,
          // íŒŒì¼ ë‚´ìš© ìì²´ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŒ. ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìœ„í•´ ì„ì‹œ dataUrl ì €ì¥
          dataUrl: file.dataUrl || null,
        }));
        localStorage.setItem(
          "pic2searchpdf_savedFiles",
          JSON.stringify(fileMetadata)
        );
      }

      // ë“œë˜ê·¸ì•¤ë“œë¡­ ë° í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragging");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragging");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragging");
        const files = Array.from(e.dataTransfer.files);
        addFiles(files);
      });

      fileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        addFiles(files);
        fileInput.value = ""; // ì¤‘ë³µ ì„ íƒ ë°©ì§€
      });

      async function addFiles(files) {
        for (const file of files) {
          // ì¤‘ë³µ íŒŒì¼ëª… ì²´í¬ ë° ì¶”ê°€ (íŒŒì¼ëª…ê³¼ ì‚¬ì´ì¦ˆê°€ ë™ì¼í•œ ê²½ìš°)
          if (
            !selectedFiles.some(
              (f) => f.name === file.name && f.size === file.size
            )
          ) {
            // HEIC/HEIF íŒŒì¼ì„ ë¯¸ë¦¬ë³´ê¸° ìœ„í•´ ë¨¼ì € ë³€í™˜
            let dataUrl = null;
            if (
              file.type === "image/heic" ||
              file.name.toLowerCase().endsWith(".heic") ||
              file.name.toLowerCase().endsWith(".heif")
            ) {
              try {
                const reader = new FileReader();
                const arrayBuffer = await new Promise((resolve, reject) => {
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = reject;
                  reader.readAsArrayBuffer(file);
                });
                const blob = new Blob([arrayBuffer]);
                const conversionResult = await heic2any({
                  blob,
                  toType: "image/jpeg",
                  quality: 0.9,
                });
                const convertedBlob =
                  conversionResult instanceof Blob
                    ? conversionResult
                    : conversionResult[0];
                dataUrl = await new Promise((resolve, reject) => {
                  const convReader = new FileReader();
                  convReader.onload = () => resolve(convReader.result);
                  convReader.onerror = reject;
                  convReader.readAsDataURL(convertedBlob);
                });
              } catch (e) {
                console.error("HEIC preview conversion failed:", e);
                dataUrl = null; // ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨ ì‹œ null
              }
            } else if (file.type.startsWith("image/")) {
              dataUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
              });
            }

            selectedFiles.push({
              file: file, // ì‹¤ì œ File ê°ì²´
              name: file.name,
              type: file.type,
              size: file.size,
              lastModified: file.lastModified,
              dataUrl: dataUrl, // ë¯¸ë¦¬ë³´ê¸°ìš© Data URL
            });
          }
        }
        renderFileList();
        outputDiv.style.display = "none";
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        saveFilesToLocalStorage(); // íŒŒì¼ ì¶”ê°€ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      }

      function renderFileList() {
        fileList.innerHTML = "";
        selectedFiles.forEach((fileInfo, index) => {
          const li = document.createElement("li");
          li.className = "file-item";
          li.setAttribute("data-index", index);
          li.draggable = true; // HTML Drag & Drop API í™œì„±í™”
          li.innerHTML = `
            <img src="${
              fileInfo.dataUrl ||
              "data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%23ccc%22%20d%3D%22M19%205v14H5V5h14m0-2H5c-1.1%200-2%20.9-2%202v14c0%201.1.9%202%202%202h14c1.1%200%202-.9%202-2V5c0-1.1-.9-2-2-2zm-4.85%206.59l-2.2-2.2a.5.5%200%200%200-.7%200L7%2014.28V17h2.72l4.63-4.63a.5.5%200%200%200%200-.7l-2.2-2.2zM15%2010c.55%200%201-.45%201-1s-.45-1-1-1s-1%20.45-1%201s.45%201%201%201z%22%2F%3E%3C%2Fsvg%3E"
            }" alt="${fileInfo.name}" class="file-preview">
            <span class="file-name">${fileInfo.name}</span>
            <button class="remove-file-btn" data-index="${index}">&times;</button>
          `;
          fileList.appendChild(li);
        });

        // íŒŒì¼ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        fileList.querySelectorAll(".remove-file-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            const indexToRemove = parseInt(e.target.dataset.index);
            selectedFiles.splice(indexToRemove, 1);
            renderFileList();
            saveFilesToLocalStorage(); // ì‚­ì œ í›„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
            outputDiv.style.display = "none"; // ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
            progressContainer.style.display = "none";
          });
        });
      }

      // SortableJSë¥¼ ì´ìš©í•´ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ìˆœì„œ ì¡°ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
      new Sortable(fileList, {
        animation: 150,
        onEnd: (evt) => {
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          if (oldIndex === newIndex) return;
          const movedItem = selectedFiles.splice(oldIndex, 1)[0];
          selectedFiles.splice(newIndex, 0, movedItem);
          renderFileList(); // ìˆœì„œ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ data-index ì—…ë°ì´íŠ¸
          saveFilesToLocalStorage(); // ìˆœì„œ ë³€ê²½ í›„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
          outputDiv.style.display = "none"; // ê²°ê³¼ ì˜ì—­ ìˆ¨ê¸°ê¸°
          progressContainer.style.display = "none";
        },
      });

      async function startConversion() {
        if (selectedFiles.length === 0) {
          alert("ìµœì†Œ í•œ ê°œ ì´ìƒì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        outputDiv.style.display = "none";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";

        const doOCR = doOCRCheckbox.checked;
        const languageCheckboxes = document.querySelectorAll(
          ".ocr-languages input[type=checkbox]:checked"
        );
        const languages =
          Array.from(languageCheckboxes)
            .map((el) => el.value)
            .join("+") || "kor"; // ì„ íƒëœ ì–¸ì–´ê°€ ì—†ìœ¼ë©´ í•œêµ­ì–´ ê¸°ë³¸

        const pdfDoc = await PDFLib.PDFDocument.create();

        let fullText = "";
        let ocrProgress = 0; // OCR ì§„í–‰ë¥  ì¶”ì 

        // Tesseract.js worker ì´ˆê¸°í™” (í•œ ë²ˆë§Œ)
        if (doOCR && !worker) {
          worker = await Tesseract.createWorker({
            logger: (m) => {
              if (m.status === "recognizing text" && m.progress) {
                const overallProgress = (i + m.progress) / selectedFiles.length; // ì „ì²´ ì´ë¯¸ì§€ ëŒ€ë¹„ OCR ì§„í–‰ë¥ 
                progressBar.style.width = `${Math.round(
                  overallProgress * 100
                )}%`;
                progressBar.textContent = `${Math.round(
                  overallProgress * 100
                )}% ë³€í™˜ ì¤‘...`;
              }
            },
          });
          await worker.loadLanguage(languages);
          await worker.initialize(languages);
        } else if (doOCR && worker) {
          // ì´ë¯¸ ì›Œì»¤ê°€ ìˆìœ¼ë©´ ì–¸ì–´ë§Œ ë‹¤ì‹œ ë¡œë“œ
          await worker.loadLanguage(languages);
          await worker.initialize(languages);
        }

        for (let i = 0; i < selectedFiles.length; i++) {
          progressBar.style.width = `${Math.round(
            (i / selectedFiles.length) * 100
          )}%`;
          progressBar.textContent = `${Math.round(
            (i / selectedFiles.length) * 100
          )}% ë³€í™˜ ì¤‘...`;

          const file = selectedFiles[i].file; // ì‹¤ì œ File ê°ì²´ ì‚¬ìš©
          let imageDataUrl;

          try {
            imageDataUrl = await convertFileToDataURL(file);
          } catch (err) {
            alert(`ì´ë¯¸ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${file.name}`);
            continue;
          }

          const img = new Image();
          img.src = imageDataUrl;

          await new Promise((resolve) => (img.onload = resolve));

          let pdfImage;
          if (file.type.startsWith("image/png")) {
            pdfImage = await pdfDoc.embedPng(imageDataUrl);
          } else {
            pdfImage = await pdfDoc.embedJpg(imageDataUrl);
          }

          const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
          page.drawImage(pdfImage, {
            x: 0,
            y: 0,
            width: pdfImage.width,
            height: pdfImage.height,
          });

          if (doOCR && worker) {
            try {
              const {
                data: { text },
              } = await worker.recognize(imageDataUrl);
              fullText += `----- [${file.name}] -----\n` + text.trim() + "\n\n";
            } catch (e) {
              console.error(`OCR ì‹¤íŒ¨: ${file.name}`, e);
              fullText += `----- [${file.name}] -----\nOCR ì‹¤íŒ¨\n\n`;
            }
          }
        }

        progressBar.style.width = `100%`;
        progressBar.textContent = `100% ë³€í™˜ ì™„ë£Œ!`;

        // PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const pdfBytes = await pdfDoc.save();
        const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });
        const pdfUrl = URL.createObjectURL(pdfBlob);

        downloadPdfLink.href = pdfUrl;
        downloadPdfLink.download = "Pic2SearchPdf_converted.pdf"; // ë‹¤ìš´ë¡œë“œ íŒŒì¼ëª… ì§€ì •

        outputDiv.style.display = "block"; // ê²°ê³¼ ì˜ì—­ ë³´ì—¬ì£¼ê¸°

        if (doOCR) {
          ocrTextResultDiv.style.display = "block";
          ocrExtractedText.textContent =
            fullText || "ì¸ì‹ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
        } else {
          ocrTextResultDiv.style.display = "none";
        }

        // Tesseract worker ì¢…ë£Œ (ë¦¬ì†ŒìŠ¤ í•´ì œ)
        if (worker) {
          await worker.terminate();
          worker = null;
        }
      }

      async function convertFileToDataURL(file) {
        if (
          file.type === "image/heic" ||
          file.name.toLowerCase().endsWith(".heic") ||
          file.name.toLowerCase().endsWith(".heif")
        ) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async function () {
              const blob = new Blob([reader.result]);
              try {
                const conversionResult = await heic2any({
                  blob,
                  toType: "image/jpeg",
                  quality: 0.9,
                });
                const convertedBlob =
                  conversionResult instanceof Blob
                    ? conversionResult
                    : conversionResult[0];
                const convReader = new FileReader();
                convReader.onload = () => resolve(convReader.result);
                convReader.onerror = () => reject("HEIC ë³€í™˜ ì‹¤íŒ¨");
                convReader.readAsDataURL(convertedBlob);
              } catch (e) {
                reject("HEIC ë³€í™˜ ì¤‘ ì˜¤ë¥˜: " + e.message);
              }
            };
            reader.onerror = () => reject("HEIC íŒŒì¼ ì½ê¸° ì‹¤íŒ¨");
            reader.readAsArrayBuffer(file);
          });
        } else if (file.type.startsWith("image/")) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject("ì´ë¯¸ì§€ ì½ê¸° ì‹¤íŒ¨");
            reader.readAsDataURL(file);
          });
        } else {
          return Promise.reject("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
        }
      }
    </script>
  </body>
</html>
