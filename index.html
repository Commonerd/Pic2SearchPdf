<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>이미지 PDF + OCR 변환기 (HEIC 지원)</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f2f5f9;
        color: #333;
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      p {
        font-size: 1rem;
        margin-bottom: 1rem;
        max-width: 600px;
        text-align: center;
      }
      input[type="file"] {
        margin: 1rem 0;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: white;
        width: 300px;
      }
      #fileList {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 1rem 0;
        width: 100%;
        max-width: 600px;
      }
      .file-item {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .file-controls button {
        margin-left: 0.5rem;
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
      }
      button.convert-btn {
        background: #0070f3;
        color: white;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s ease;
        margin-top: 1rem;
        user-select: none;
      }
      button.convert-btn:hover {
        background: #005ac1;
      }
      #output {
        margin-top: 2rem;
        max-width: 800px;
        text-align: left;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        white-space: pre-wrap;
      }
      pre {
        background: #f9f9f9;
        padding: 1rem;
        border-left: 4px solid #0070f3;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-bottom: 1rem;
      }
      .progress-container {
        width: 100%;
        max-width: 600px;
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        margin: 1rem 0;
        height: 20px;
      }
      .progress-bar {
        height: 100%;
        width: 0;
        background: #0070f3;
        transition: width 0.3s ease;
      }
      .ocr-options {
        margin: 1rem 0;
        max-width: 600px;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .ocr-options label {
        margin-right: 1rem;
        cursor: pointer;
        user-select: none;
      }
      .ocr-languages {
        margin-top: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .ocr-languages label {
        display: flex;
        align-items: center;
      }
      .ocr-languages input[type="checkbox"] {
        margin-right: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>이미지를 PDF로 변환하고 OCR 텍스트 인식하기</h1>
    <p>
      JPG, PNG, HEIC, WEBP, BMP, TIFF 등 다양한 이미지 업로드 가능. OCR 언어
      선택과 수행 여부 지정 가능.
    </p>

    <input
      type="file"
      id="fileInput"
      accept="image/*,.heic,.heif,.tiff,.bmp"
      multiple
    />
    <div id="fileList"></div>

    <div class="ocr-options">
      <label><input type="checkbox" id="doOCR" checked /> OCR 수행하기</label>
      <div class="ocr-languages">
        <label><input type="checkbox" value="kor" checked /> 한국어</label>
        <label><input type="checkbox" value="eng" checked /> 영어</label>
        <label><input type="checkbox" value="jpn" /> 일본어</label>
        <label><input type="checkbox" value="rus" /> 러시아어</label>
        <label><input type="checkbox" value="chi_sim" /> 중국어 (간체)</label>
        <label><input type="checkbox" value="spa" /> 스페인어</label>
      </div>
    </div>

    <button class="convert-btn" onclick="startConversion()">
      📄 PDF로 변환 + OCR 인식
    </button>

    <div class="progress-container" style="display: none">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      let selectedFiles = [];

      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");
      const outputDiv = document.getElementById("output");
      const progressContainer = document.querySelector(".progress-container");
      const progressBar = document.getElementById("progressBar");
      const doOCRCheckbox = document.getElementById("doOCR");

      fileInput.addEventListener("change", (e) => {
        selectedFiles = Array.from(e.target.files);
        renderFileList();
        outputDiv.innerHTML = "";
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
      });

      function move(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= selectedFiles.length) return;
        const temp = selectedFiles[index];
        selectedFiles[index] = selectedFiles[newIndex];
        selectedFiles[newIndex] = temp;
        renderFileList();
      }

      function renderFileList() {
        fileList.innerHTML = "";
        selectedFiles.forEach((file, index) => {
          const div = document.createElement("div");
          div.className = "file-item";
          div.innerHTML = `
            <span>${file.name}</span>
            <span class="file-controls">
              <button onclick="move(${index}, -1)" title="위로 이동">⬆</button>
              <button onclick="move(${index}, 1)" title="아래로 이동">⬇</button>
            </span>`;
          fileList.appendChild(div);
        });
      }

      async function startConversion() {
        if (selectedFiles.length === 0) {
          alert("파일을 선택하세요.");
          return;
        }

        const doOCR = doOCRCheckbox.checked;
        const selectedLangs = Array.from(
          document.querySelectorAll(
            '.ocr-languages input[type="checkbox"]:checked'
          )
        ).map((input) => input.value);

        if (doOCR && selectedLangs.length === 0) {
          alert("OCR 언어를 한 개 이상 선택하세요.");
          return;
        }

        progressContainer.style.display = "block";
        outputDiv.innerHTML = "";
        progressBar.style.width = "0%";

        const pdfDoc = await PDFLib.PDFDocument.create();

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          let imageFile = file;

          if (
            file.name.toLowerCase().endsWith(".heic") ||
            file.name.toLowerCase().endsWith(".heif")
          ) {
            try {
              const convBlob = await heic2any({
                blob: file,
                toType: "image/jpeg",
              });
              imageFile = new File(
                [convBlob],
                file.name.replace(/\.(heic|heif)$/i, ".jpg"),
                {
                  type: "image/jpeg",
                }
              );
            } catch (e) {
              alert("HEIC 변환 실패: " + file.name);
              continue;
            }
          }

          const imageDataUrl = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(imageFile);
          });

          const img = new Image();
          img.src = imageDataUrl;
          await new Promise((res) => (img.onload = res));

          const canvas = document.createElement("canvas");
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          canvas.getContext("2d").drawImage(img, 0, 0);

          const imgBytes = await fetch(canvas.toDataURL("image/jpeg")).then(
            (res) => res.arrayBuffer()
          );
          const pdfImage = await pdfDoc.embedJpg(imgBytes);
          const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
          page.drawImage(pdfImage, {
            x: 0,
            y: 0,
            width: pdfImage.width,
            height: pdfImage.height,
          });

          if (doOCR) {
            outputDiv.innerHTML += `=== ${file.name} ===\n`;
            try {
              const {
                data: { text },
              } = await Tesseract.recognize(
                imageDataUrl,
                selectedLangs.join("+"),
                {
                  logger: (m) => {
                    if (m.status === "recognizing text") {
                      const progress =
                        ((i + m.progress) / selectedFiles.length) * 100;
                      progressBar.style.width = progress + "%";
                    }
                  },
                }
              );
              outputDiv.innerHTML += text + "\n\n";
            } catch (err) {
              outputDiv.innerHTML += "OCR 실패: " + err.message + "\n\n";
            }
          } else {
            progressBar.style.width =
              ((i + 1) / selectedFiles.length) * 100 + "%";
          }
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "converted.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
