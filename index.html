<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>이미지 PDF + OCR 변환기</title>
  </head>
  <body>
    <h1>이미지를 PDF로 변환 + OCR</h1>
    <input
      type="file"
      id="fileInput"
      multiple
      accept="image/*,.heic,.tiff,.bmp"
    />
    <div>
      <label><input type="checkbox" id="ocrToggle" checked /> OCR 수행</label>
      <fieldset>
        <legend>OCR 언어 선택</legend>
        <label
          ><input type="checkbox" class="lang" value="kor" checked />
          한국어</label
        >
        <label
          ><input type="checkbox" class="lang" value="eng" checked />
          영어</label
        >
        <label><input type="checkbox" class="lang" value="jpn" /> 일본어</label>
        <label
          ><input type="checkbox" class="lang" value="rus" /> 러시아어</label
        >
        <label
          ><input type="checkbox" class="lang" value="chi_sim" /> 중국어
          간체</label
        >
        <label
          ><input type="checkbox" class="lang" value="spa" /> 스페인어</label
        >
      </fieldset>
    </div>
    <button id="convertBtn">PDF 변환</button>
    <div
      id="progress"
      style="
        display: none;
        margin-top: 1rem;
        background: #eee;
        height: 20px;
        width: 100%;
      "
    >
      <div
        id="progressBar"
        style="height: 100%; width: 0%; background: #0070f3"
      ></div>
    </div>
    <pre
      id="output"
      style="
        margin-top: 2rem;
        background: #f9f9f9;
        padding: 1rem;
        max-height: 300px;
        overflow: auto;
      "
    ></pre>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      const fileInput = document.getElementById("fileInput");
      const convertBtn = document.getElementById("convertBtn");
      const output = document.getElementById("output");
      const progressBar = document.getElementById("progressBar");
      const progress = document.getElementById("progress");

      convertBtn.onclick = async () => {
        const files = Array.from(fileInput.files);
        if (files.length === 0) return alert("파일을 선택하세요.");

        const doOCR = document.getElementById("ocrToggle").checked;
        const langs = Array.from(
          document.querySelectorAll(".lang:checked")
        ).map((e) => e.value);
        if (doOCR && langs.length === 0) return alert("OCR 언어를 선택하세요.");

        convertBtn.disabled = true;
        output.textContent = "";
        progress.style.display = "block";
        progressBar.style.width = "0%";

        const pdfDoc = await PDFLib.PDFDocument.create();

        for (let i = 0; i < files.length; i++) {
          let file = files[i];
          if (file.type === "image/heic") {
            try {
              const blob = await heic2any({ blob: file, toType: "image/jpeg" });
              file = new File([blob], file.name.replace(/\.heic$/i, ".jpg"), {
                type: "image/jpeg",
              });
            } catch (e) {
              alert("HEIC 변환 실패: " + e.message);
              convertBtn.disabled = false;
              return;
            }
          }

          const bytes = await file.arrayBuffer();
          const img = file.type.includes("png")
            ? await pdfDoc.embedPng(bytes)
            : await pdfDoc.embedJpg(bytes);
          const page = pdfDoc.addPage([img.width, img.height]);
          page.drawImage(img, {
            x: 0,
            y: 0,
            width: img.width,
            height: img.height,
          });

          if (doOCR) {
            output.textContent += `\n[${file.name}] OCR 중...`;
            const text = await Tesseract.recognize(file, langs.join("+"));
            output.textContent += "\n" + text.data.text;
          }

          progressBar.style.width = `${Math.round(
            ((i + 1) / files.length) * 100
          )}%`;
        }

        const pdfBytes = await pdfDoc.save();
        const url = URL.createObjectURL(
          new Blob([pdfBytes], { type: "application/pdf" })
        );

        const link = document.createElement("a");
        link.href = url;
        link.download = "converted.pdf";
        link.textContent = "PDF 다운로드";
        output.appendChild(document.createElement("hr"));
        output.appendChild(link);

        convertBtn.disabled = false;
      };
    </script>
  </body>
</html>
